# Formatters

Adding context to alerts is done by the formatters. Formatters generate all the content that may
be used by one or more message types. For example, certain parts of text returned by a Nagios check
can be highlighted to grab the operator's attention. Helper functions can be called to generate
additional content such as image attachments or search results.

All content generated by a formatter is stored in a hash (a class instance variable in the
formatter object). The hash looks similar to the following:

```ruby
@content = {
  :attachments => [],
  :html => {
    :additonal_info => "",
    :additional_details => "" 
  },
  :subject => "",
  :text => {
    :additonal_info => "",
    :additional_details => ""
  }
}
```

TODO: Write doc on messages and helpers.

**NOTE**: The subkeys under the ``:html`` and ``:text`` keys are generated by formatter methods of the
same name.

## Formatter Methods

The base formatter (``Formatter::Base``) defines a set of core methods useful for generating content.
These methods can be overridden in subclassed formatters to do anything. **The only limit is your
imagination.**

    ack_info
    additional_details
    additional_info
    alert_ack_url
    host_info
    notes
    notification_info
    recipients_email_link
    short_ack_info
    short_state_detail
    state_info

See below for an example of content generated using some of the above methods.

<img src="/docs/assets/img/nagios-herald-formatter-content-example.png" style="border:1px solid #a1a1a1;">

## Writing the Formatter

To write a formatter, create a new formatter class (i.e. ``check_disk.rb``) and inherit from ``NagiosHerald::Formatter``.

```ruby
module NagiosHerald
  module Formatter
    class CheckDisk < NagiosHerald::Formatter
      include NagiosHerald::Logging

      def additional_details
        "nagios-herald makes alerting more bearable."
      end

    end
  end
end
```

### Naming Convention

* Formatters live in ``lib/nagios-herald/formatters``.
* The file names **MUST** lower-cased and underscored.
* The class names **MUST** be CamelCased.

For example, our ``CheckDisk`` formatter class would reside in a file named ``check_disk.rb``.

This is necessary as ``nagios-herald`` preloads all known formatters when it starts so that it can
dynamically instantiate the formatter it needs when it's ready.

TODO: Give the below some attention.

2. Override the sections you want to customize.

    You can define the text and/or HTML content in a message by calling the ``add_text`` and ``add_html`` methods
    inside a formatting method:

``ruby
add_text "Something blew up!"
add_html "Something <b>blew</b> up!"
```

    An example of an overridden ``additional_info`` method could be:

```ruby
def additional_info
  section = __method__  # this defines the section key in the formatter's content hash
  hostname  = get_nagios_var("NAGIOS_HOSTNAME")
  add_text(section, "The hostname is #{hostname}")
  add_html(section, "The hostname is <b>#{hostname}</b>")
end
```

3. Optional: Inline static images in the message.

    Call the ``add_attachment`` method and specify the full path to the image file to be attached.
    The mailer will then inline the image in the HTML body of the message.

```ruby
partitions_chart = "/path/to/partition_chart.png"
add_attachment partitions_chart
add_html "<img src='#{partitions_chart}' width='300' alt='partitions_remaining_space' />"
```

4. Optional: Attach documents to the message.

    Call the ``add_attachment`` method and specify the full path to the document to be attached.  **Done**.

        add_attachment "/path/to/file.zip"

